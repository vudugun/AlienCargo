(function(){"use strict";var t=Math.round,o=Math.floor,n=Math.max,a=Math.min,i=Math.PI;function e(){const e=BABYLON.Vector3.Up();BABYLON.Vector3.fromLocationRCH=function(e,t,o){return new BABYLON.Vector3(-t,o,-e)},BABYLON.Quaternion.CW=function(e){return BABYLON.Quaternion.RotationAxis(e,-(i/2))},BABYLON.Quaternion.CCW=function(e){return BABYLON.Quaternion.RotationAxis(e,i/2)},BABYLON.Quaternion.Orientation=function(t){switch(t){case"n":return BABYLON.Quaternion.RotationAxis(e,0);case"e":return BABYLON.Quaternion.RotationAxis(e,-(i/2));case"s":return BABYLON.Quaternion.RotationAxis(e,Math.PI);case"w":return BABYLON.Quaternion.RotationAxis(e,i/2);default:console.error("Unknown orientation: "+t);}}}class l{constructor(e){this._screen=e}init(){const e=this._screen.assets.getText("maps");this._maps=JSON.parse(e)}getCount(e){return this._maps[e].length}get(e,t){return this._maps[e][t-1]}}class _{constructor(e,t,o){this._r=e,this._c=t,this._h=o}static equal(e,t){return!(null!==e||null!==t)||!(null===e||null===t)&&e.r===t.r&&e.c===t.c&&e.h===t.h}get r(){return this._r}get c(){return this._c}get h(){return this._h}dr(e){return new _(this.r+e,this.c,this.h)}dc(e){return new _(this.r,this.c+e,this.h)}dh(e){return new _(this.r,this.c,this.h+e)}sr(e){return new _(e,this.c,this.h)}sc(e){return new _(this.r,e,this.h)}sh(e){return new _(this.r,this.c,e)}dd(e){switch(e){case"n":return this.dr(-1);case"e":return this.dc(1);case"s":return this.dr(1);case"w":return this.dc(-1);case"u":return this.dh(1);case"d":return this.dh(-1);default:console.error("Unknown direction: "+e);}}}class s{constructor(e){this._grid=e,this._parent=null,this._location=null}dispose(){}get parent(){return this._parent}set parent(e){this._parent=e}get location(){return this._location}set location(e){if(console.assert(!_.equal(e,this._location)),this._location&&this._grid.set(this._location,void 0),this._location=e,this._location){const e=this._grid.get(this._location);e&&(e.location=null),this._grid.set(this._location,this)}}}class r extends s{constructor(e){super(e)}}class d extends s{constructor(e){super(e)}get parent(){return super.parent}set parent(e){e?(super.parent=e,super.parent.payload=this,this.location=null):(this.location=this.parent.location,super.parent.payload=null,super.parent=null)}isLifted(){if(!this.parent)return!1;const e=this.parent.location,t=this._grid.get(e.dh(1));return!(t instanceof d)}isOnGoal(){if(this.isLifted())return!1;const e=this.parent?this.parent.location:this.location,t=this._grid.get(e.sh(0));return!!(t instanceof r)}}class c{constructor(){this._grid=[],this._cratesCount=0,this._cratesOnGoal=0,this._goalsCount=0,this._goalsWithCrates=0}dispose(){for(let e=0,t=this.getRowCount();e<t;++e)for(let t=0,o=this.getColumnCount(e);t<o;++t)for(let o=0,n=this.getHeight(e,t);o<n;++o){const n=this.getRCH(e,t,o);n&&n.dispose()}this._grid=null}get cratesCount(){return this._cratesCount}get cratesOnGoal(){return this._cratesOnGoal}get goalsCount(){return this._goalsCount}get goalsWithCrates(){return this._goalsWithCrates}getRowCount(){return this._grid.length}getColumnCount(e){return void 0===this._grid[e]?0:this._grid[e].length}getHeight(e,t){return void 0===this._grid[e]?0:void 0===this._grid[e][t]?0:this._grid[e][t].length}get({r:e,c:t,h:o}){return this.getRCH(e,t,o)}getRCH(e,t,o){return void 0===this._grid[e]||void 0===this._grid[e][t]?void 0:this._grid[e][t][o]}set({r:e,c:t,h:o},n){this.setRCH(e,t,o,n)}setRCH(e,t,o,n){this._grid[e]===void 0&&(this._grid[e]=[]),this._grid[e][t]===void 0&&(this._grid[e][t]=[]);const a=this._grid[e][t][o];this._updateCounters(e,t,o,a,-1),this._grid[e][t][o]=n,this._updateCounters(e,t,o,n,1)}_updateCounters(e,t,o,n,a){if(n instanceof r)this._goalsCount+=a;else if(n instanceof d){this._cratesCount+=a;const n=this.getRCH(e,t,0);n instanceof r&&(this._cratesOnGoal+=a,1===o&&(this._goalsWithCrates+=a))}}}class u extends s{constructor(e){super(e)}}class p extends s{constructor(e){super(e)}}class m{constructor(){this._callbacks=[]}add(e){console.assert(-1===this._callbacks.indexOf(e),"Duplicate callback: "+e),this._callbacks.push(e)}remove(e){console.assert(0<=this._callbacks.indexOf(e),"Unknown callback: "+e);const t=this._callbacks.indexOf(e);this._callbacks.splice(t,1)}notify(...e){for(const t of this._callbacks)t(...e)}}class g{static getOpposite(e){switch(e){case"n":return"s";case"e":return"w";case"s":return"n";case"w":return"e";case"u":return"d";case"d":return"u";default:console.error("Unknown direction: "+e);}}static getCW(e){switch(e){case"n":return"e";case"e":return"s";case"s":return"w";case"w":return"n";default:console.error("Unknown direction: "+e);}}static getCCW(e){switch(e){case"n":return"w";case"e":return"n";case"s":return"e";case"w":return"s";default:console.error("Unknown direction: "+e);}}}class b extends s{constructor(e){super(e),this._height=0,this.payload=null,this._initEvents()}get height(){return this._height}set height(e){if(e!==this._height&&this._canMove(e)){const t=this._height;this._height=e,this.updateLocation(),this.onMove.notify(t,this._height)}}get cratesCount(){return this.payload instanceof d?1:0}updateLocation(){this.location=this._computeLocation(this.height)}_initEvents(){this.onMove=new m}_canMove(e){const t=a(this.height,e),o=n(this.height,e);for(let n=t;n<=o;++n){if(n===this.height)continue;const e=this._computeLocation(n),t=this._grid.get(e);if(t)return!1}return!0}_computeLocation(e){const t=this.parent.location,o=this.parent.orientation;return t.dd(o).dh(e)}}class k extends s{constructor(e,t){super(e),this._orientation=t,this._moves=[],this._createForks(),this._initCallbacks(),this._initEvents()}dispose(){this._disposeEvents(),super.dispose()}get location(){return super.location}set location(e){super.location=e,this._forks.updateLocation()}get orientation(){return this._orientation}set orientation(e){this._orientation=e,this._forks.updateLocation()}move(e){switch(e){case"n":case"e":case"s":case"w":e===this.orientation?this._moveForward(e):e===g.getOpposite(this.orientation)?this._moveBackward(e):e===g.getCW(this.orientation)?this._rotateCW(e):e===g.getCCW(this.orientation)&&this._rotateCCW(e);break;case"F":this._moveForward(this.orientation);break;case"B":this._moveBackward(g.getOpposite(this.orientation));break;case"CW":this._rotateCW(g.getCW(this.orientation));break;case"CCW":this._rotateCCW(g.getCCW(this.orientation));break;case"1":this._moveForks(0);break;case"2":this._moveForks(1);break;case"3":this._moveForks(2);break;default:console.error("Unknown action: "+e);}}get moves(){return this._moves}get cratesCount(){return this._forks.cratesCount}_createForks(){this._forks=new b(this._grid),this._forks.parent=this}_initCallbacks(){this._forks_onMoveCallback=this._forks_onMove.bind(this)}_initEvents(){this.onMoveForward=new m,this.onMoveBackward=new m,this.onRotateCW=new m,this.onRotateCCW=new m,this.onForksMove=new m,this._forks.onMove.add(this._forks_onMoveCallback)}_disposeEvents(){this._forks.onMove.remove(this._forks_onMoveCallback)}_moveForward(e){if(!this._canMoveForward(e))return;let t=null;const o=this._forks.location.dd(e),n=this._grid.get(o);n instanceof d&&(t=n,t.parent=this._forks),this.location=this.location.dd(e),this._moves.push("F"),this.onMoveForward.notify(t)}_canMoveForward(e){return this._canMoveForksForward(e)&&this._canMoveTractorForward(e)}_canMoveForksForward(e){const t=this._forks.location.dd(e),o=this._grid.get(t);return!o||o instanceof d&&!this._forks.payload}_canMoveTractorForward(e){for(let t=0;3>t;++t){if(t===this._forks.height)continue;const o=this.location.dd(e).dh(t),n=this._grid.get(o);if(n)return!1}return!0}_moveBackward(e){if(!this._canMoveBackward(e))return;let t=null;if(this._forks.payload){const e=this._forks.location.dh(-1),o=this._grid.get(e);o&&(t=this._forks.payload,t.parent=null)}this.location=this.location.dd(e),this._moves.push("B"),this.onMoveBackward.notify(t)}_canMoveBackward(e){const t=this.location.dd(e),o=this._grid.get(t);return!o}_rotateCW(e){this._canRotate(e)&&(this.orientation=e,this._moves.push("CW"),this.onRotateCW.notify())}_rotateCCW(e){this._canRotate(e)&&(this.orientation=e,this._moves.push("CCW"),this.onRotateCCW.notify())}_canRotate(e){const t=this._forks.location.dh(1),o=this._grid.get(t);if(o)return!1;const n=this._forks.location.dd(e),a=this._grid.get(n);if(a)return!1;const i=n.dd(g.getOpposite(this.orientation)),l=this._grid.get(i);return!l}_moveForks(e){this._forks.height=e}_forks_onMove(e,t){this._moves.push(t+1+""),this.onForksMove.notify(e,t)}}class v{constructor(e){this._map=e,this._createGrid()}dispose(){this._disposeGrid()}get number(){return this._map.number}get solution(){return this._map.solution}get grid(){return this._grid}get moves(){return this._forklift.moves}get cratesCount(){return this._grid.cratesCount+this._forklift.cratesCount}get cratesOnGoal(){return this._grid.cratesOnGoal}get goalsCount(){return this._grid.goalsCount}get goalsWithCrates(){return this._grid.goalsWithCrates}reset(){this._disposeGrid(),this._createGrid()}move(e){this._forklift.move(e)}isSolved(){return!(this.cratesOnGoal!==this.cratesCount)&&!(this.goalsWithCrates!==this.goalsCount)}_createGrid(){console.assert(!this._grid);const e=this._map.diagram;this._grid=new c;for(let t=0,o=e.length;t<o;++t)for(let o=0,n=e[t].length;o<n;++o)for(let n=0,a=e[t][o].length;n<a;++n){const a=e[t][o][n],i=this._createEntity(a);i&&(i.location=new _(o,n,t))}}_createEntity(e){switch(e){case"#":return new u(this._grid);case".":return new p(this._grid);case"x":return new r(this._grid);case"o":return new d(this._grid);case"^":return this._forklift=new k(this._grid,"n"),this._forklift;case">":return this._forklift=new k(this._grid,"e"),this._forklift;case"v":return this._forklift=new k(this._grid,"s"),this._forklift;case"<":return this._forklift=new k(this._grid,"w"),this._forklift;case" ":break;default:console.error("Unknown element: "+e);}}_disposeGrid(){this._grid.dispose(),this._grid=null}}class h{constructor(e){this._scene=e,this._promises=[],this._images=new Map,this._texts=new Map,this._assetsManager=new BABYLON.AssetsManager(this._scene)}loadAsync(e){return this._loadMeshes(e.meshes||[]),this._loadImages(e.images||[]),this._loadFonts(e.fonts||[]),this._loadSounds(e.sounds||[]),this._loadTexts(e.texts||[]),this._promises.push(new Promise((e,t)=>{this._assetsManager.onTasksDoneObservable.add(()=>{e()}),this._assetsManager.onTaskErrorObservable.add(e=>{const o=e.errorObject;console.error(o.message,o.exception),t()}),this._assetsManager.load()})),Promise.all(this._promises)}createMesh(e){const t=this._scene.getMeshByName(e),o=t.clone(e);o.layerMask=268435455;for(const t of o.getChildMeshes(!1))t.layerMask=268435455;return o}getImage(e){return this._images.get(e)}getSound(e){return this._scene.getSoundByName(e)}getText(e){return this._texts.get(e)}_loadMeshes(e){for(const t of e){const e=this._assetsManager.addMeshTask("","","assets/meshes/",t+".glb");e.onSuccess=e=>{for(const t of e.loadedMeshes)t.layerMask=0}}}_loadImages(e){for(const t of e){const e=this._stripExtension(t),o=this._assetsManager.addImageTask(t,"assets/images/"+t);o.onSuccess=t=>{this._images.set(e,t.image)}}}_loadFonts(e){for(const t of e){const e=new FontFaceObserver(t);this._promises.push(e.load())}}_loadSounds(e){for(const t of e){const e=this._stripExtension(t);this._assetsManager.addSoundTask("",e,"assets/sounds/"+t)}}_loadTexts(e){for(const t of e){const e=this._stripExtension(t),o=this._assetsManager.addTextFileTask(t,"assets/texts/"+t);o.onSuccess=t=>{this._texts.set(e,t.text)}}}_stripExtension(e){return e.substring(0,e.lastIndexOf("."))}}class C{constructor(e){this._screen=e,this._mesh=null}dispose(){this._mesh.dispose()}get position(){return this._mesh.position}set position(e){this._mesh.position=e}get parentMesh(){return this._mesh.parent}set parentMesh(e){this._mesh.parent=e}set isVisible(e){const t=e?268435455:0;this._mesh.layerMask=t;for(const o of this._mesh.getChildMeshes(!1))o.layerMask=t}// fadeIn/fadeOut require:
// - material.forceDepthWrite = true;
// - material.transparencyMode = BABYLON.PBRMaterial.PBRMATERIAL_ALPHABLEND; 
fadeIn(e){const t=this._mesh.visibility,o=this._createFadeAnimation(30*e,t,1);this._mesh.animations=[],this._mesh.animations.push(o);const n=this._mesh.getScene();n.beginAnimation(this._mesh)}fadeOut(e){const t=this._mesh.visibility,o=this._createFadeAnimation(30*e,t,0);this._mesh.animations=[],this._mesh.animations.push(o);const n=this._mesh.getScene();n.beginAnimation(this._mesh)}_createFadeAnimation(e,t,o){const n=new BABYLON.Animation("fade","visibility",30,BABYLON.Animation.ANIMATIONTYPE_FLOAT,BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);return n.setKeys([{frame:0,value:t},{frame:e,value:o}]),n}}class f extends C{constructor(e){super(e),this._initImages(),this._createMesh()}set level(e){this._drawLevel(e)}_initImages(){this._digits=this._screen.assets.getImage("digits"),this._baseImage=this._screen.assets.getImage("warehouse_base"),this._scrapesMask=this._screen.assets.getImage("scrapes_mask")}_createMesh(){this._mesh=this._screen.assets.createMesh("warehouse");const e=this._mesh.getChildMeshes(!0);this._warehouseMesh=e[2],this._fanMesh=e[3],this._initMaterials(),this._initAnimations()}_initMaterials(){this._albedoTexture=this._createAlbedoTexture();const e=this._warehouseMesh.material;e.albedoTexture=this._albedoTexture}_createAlbedoTexture(){const{width:e,height:t}=this._baseImage,o=new BABYLON.DynamicTexture("",{width:e,height:t},this._screen.scene),n=o.getContext();return n.save(),n.scale(1,-1),n.drawImage(this._baseImage,0,-t+1),n.restore(),o.update(),o}_initAnimations(){this._fanMesh.animations=[],this._fanMesh.animations.push(this._createFanAnimation()),this._screen.scene.beginAnimation(this._fanMesh,0,6,!0)}_createFanAnimation(){const e=BABYLON.Vector3.Zero(),t=new BABYLON.Vector3(0,-(2*i),0),o=[];o.push({frame:0,value:e}),o.push({frame:6,value:t});const n=new BABYLON.Animation("rotate","rotation",1,BABYLON.Animation.ANIMATIONTYPE_VECTOR3,BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE);return n.setKeys(o),n}_drawLevel(e){const t=this._albedoTexture.getContext(),{width:n,height:a}=this._albedoTexture.getSize();t.clearRect(0,0,n,a),t.save(),t.scale(1,-1);// digits
const i=o(e/10%10);// scrapes
// base
//
this._drawDigit(t,i,1200,624),this._drawDigit(t,e%10,320,624),t.globalCompositeOperation="destination-out",t.drawImage(this._scrapesMask,0,-a+1),t.drawImage(this._scrapesMask,1024,-a+1),t.globalCompositeOperation="multiply",t.drawImage(this._baseImage,0,-a+1),t.restore(),this._albedoTexture.update()}_drawDigit(e,t,n,a){const i=256,l=o(t/4)*i;e.drawImage(this._digits,t%4*256,l,256,i,n,-a,512,i)}}class S extends C{constructor(e){super(e),this._createMesh(),this._initCallbacks(),this._initEvents()}dispose(){this._disposeEvents(),super.dispose()}_createMesh(){this._mesh=this._screen.assets.createMesh("space"),this._initAnimation()}_initAnimation(){var e=Number.EPSILON;const t=this._mesh.material.emissiveTexture;t.uOffset=e,t.vOffset=e;// WORKAROUND: zero does not work
const o=2*(Math.random()*i);this._stepU=Math.cos(o)/2e5,this._stepV=Math.sin(o)/2e5}_initCallbacks(){this._scene_onBeforeRenderCallback=this._scene_onBeforeRender.bind(this)}_initEvents(){this._screen.scene.registerBeforeRender(this._scene_onBeforeRenderCallback)}_disposeEvents(){this._screen.scene.unregisterBeforeRender(this._scene_onBeforeRenderCallback)}_scene_onBeforeRender(){const e=this._screen.scene.getEngine().getDeltaTime(),t=this._mesh.material.emissiveTexture;t.uOffset+=e*this._stepU,t.vOffset+=e*this._stepV}}class x{constructor(e){this._screen=e,this._alphas=new Map,this._fadeFPS=30,this._ui=null}set isEnabled(e){this._ui.executeOnAllControls(t=>{t.isEnabled=e})}set isVisible(e){this._ui.layer.layerMask=e?268435455:0}get isVisible(){268435455===this._ui.layer.layerMask}set alpha(e){this._ui.executeOnAllControls(t=>{t.alpha=e})}fadeIn(e,t=()=>{}){console.assert(0<this._alphas.size);const o=window.setInterval(()=>{let n=0;this._ui.executeOnAllControls(t=>{++n;const o=1e3/(this._fadeFPS*e),i=this._alphas.get(t.name);t.alpha=a(i,t.alpha+o),t.alpha===i&&--n}),0==n&&(window.clearInterval(o),t())},1e3/this._fadeFPS)}fadeOut(e,t=()=>{}){const o=window.setInterval(()=>{let a=0;this._ui.executeOnAllControls(t=>{++a;const o=1e3/(this._fadeFPS*e);t.alpha=n(0,t.alpha-o),0===t.alpha&&--a}),0==a&&(window.clearInterval(o),t())},1e3/this._fadeFPS)}_saveAlpha(){this._alphas.clear(),this._ui.executeOnAllControls(e=>{this._alphas.set(e.name,e.alpha)})}}const y=new class{constructor(){this._bookmarks=new Map,this._options=new Map,this._initEvents()}load(){this._loadLevelPack(),this._loadBookmarks(),this._loadOptions()}save(){this._saveLevelPack(),this._saveBookmarks(),this._saveOptions()}getLevelPack(){return this._levelPack}getBookmark(e){return this._bookmarks.has(e)||this._bookmarks.set(e,1),this._bookmarks.get(e)}setBookmark(e,t){const o=this.getBookmark(e)!==t;o&&(this._bookmarks.set(e,t),this.onBookmarkChanged.notify(e,t))}getOption(e){return this._options.get(e)}setOption(e,t){const o=this.getOption(e)!==t;o&&(this._options.set(e,t),this.onOptionChanged.notify(e,t))}_initEvents(){this.onBookmarkChanged=new m,this.onOptionChanged=new m}_loadLevelPack(){const e=window.localStorage;this._levelPack=e.getItem("level_pack")||"original"}_saveLevelPack(){const e=window.localStorage;e.setItem("level_pack",this._levelPack)}_loadBookmarks(){const e=window.localStorage;let t=e.getItem("bookmarks");t&&(t=JSON.parse(t)),this._bookmarks=new Map(t||[])}_saveBookmarks(){const e=window.localStorage,t=[...this._bookmarks];e.setItem("bookmarks",JSON.stringify(t))}_loadOptions(){const e=window.localStorage,t=JSON.parse(e.getItem("options"));this._options=new Map(t||[["forklift_speed",2],["rotation_speed",2],["forks_speed",2],["music_volume",30],["ambient_sound_volume",0],["sound_effects_volume",50]])}_saveOptions(){const e=window.localStorage,t=[...this._options];e.setItem("options",JSON.stringify(t))}};class O extends x{constructor(e){super(e),this._initCallbacks(),this._initEvents()}create(){this._createWidgets(),this._saveAlpha(),this._createSounds()}dispose(){this._ui.dispose(),this._disposeEvents()}set maxLevelNo(e){this._nextLevelSlider.maximum=e}get nextLevelNo(){return this._nextLevelSlider.value}set nextLevelNo(e){this._nextLevelSlider.value=e,this._nextLevelValue.text=e+""}_initCallbacks(){this._settings_onOptionChangedCallback=this._settings_onOptionChanged.bind(this),this._playButton_onPointerDownCallback=this._playButton_onPointerDown.bind(this),this._playButton_onPointerClickCallback=this._playButton_onPointerClick.bind(this),this._optionsButton_onPointerDownCallback=this._optionsButton_onPointerDown.bind(this),this._optionsButton_onPointerClickCallback=this._optionsButton_onPointerClick.bind(this),this._helpButton_onPointerDownCallback=this._helpButton_onPointerDown.bind(this),this._helpButton_onPointerClickCallback=this._helpButton_onPointerClick.bind(this)}_initEvents(){this.onPlay=new m,this.onOptions=new m,this.onHelp=new m,this.onNextLevelChanged=new m,y.onOptionChanged.add(this._settings_onOptionChangedCallback)}_disposeEvents(){y.onOptionChanged.remove(this._settings_onOptionChangedCallback)}_createWidgets(){this._ui=BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("main",!0,this._screen.scene),this._ui.addControl(this._createTitle()),this._ui.addControl(this._createCenterPanelBackground()),this._ui.addControl(this._createCenterPanel()),this._ui.addControl(this._createBottomPanel())}_createTitle(){const e=new BABYLON.GUI.Image("title","assets/images/title.png");return e.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP,e.width="80%",e.height="19%",e.top="3%",e}_createCenterPanelBackground(){const e=new BABYLON.GUI.Rectangle("background");return e.width="400px",e.height="344px",e.background="#000000",e.alpha=.5,e.thickness=0,e.cornerRadius=20,e}_createCenterPanel(){const e=new BABYLON.GUI.StackPanel("center_panel");return e.width="400px",e.height="344px",e.addControl(this._createPlayButtton()),e.addControl(this._createOptionsButtton()),e.addControl(this._createHelpButtton()),e}_createPlayButtton(){const e=this._createButton("play_button","Play");return e.onPointerDownObservable.add(this._playButton_onPointerDownCallback),e.onPointerClickObservable.add(this._playButton_onPointerClickCallback),e}_createOptionsButtton(){const e=this._createButton("options_button","Options");return e.onPointerDownObservable.add(this._optionsButton_onPointerDownCallback),e.onPointerClickObservable.add(this._optionsButton_onPointerClickCallback),e}_createHelpButtton(){const e=this._createButton("help_button","Help");return e.onPointerDownObservable.add(this._helpButton_onPointerDownCallback),e.onPointerClickObservable.add(this._helpButton_onPointerClickCallback),e}_createButton(e,t){const o=BABYLON.GUI.Button.CreateSimpleButton(e,t);return o.fontFamily="Native Alien Extended",o.fontSize=48,o.height="108px",o.paddingTop="16px",o.paddingLeft="16px",o.paddingRight="16px",o.color="#000000",o.background="#7092A3",o.cornerRadius=10,o}_createBottomPanel(){const e=new BABYLON.GUI.StackPanel("bottom_panel");return e.width="90%",e.height="96px",e.top="-64px",e.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM,e.addControl(this._createNextLevelPanel()),this._nextLevelSlider=this._createLevelSlider(),e.addControl(this._nextLevelSlider),e}_createNextLevelPanel(){const e=new BABYLON.GUI.StackPanel("next_level_panel");return e.isVertical=!1,e.addControl(this._createNextLevelLabel()),this._nextLevelValue=this._createNextLevelValue(),e.addControl(this._nextLevelValue),e}_createNextLevelLabel(){const e=new BABYLON.GUI.TextBlock("next_level_label");return e.text="Next level:",e.width="176px",e.height="64px",e.fontFamily="Native Alien Extended",e.color="#ffffff",e.fontSize=24,e}_createNextLevelValue(){const e=new BABYLON.GUI.TextBlock("next_level_value");return e.width="36px",e.height="64px",e.fontFamily="Native Alien Extended",e.color="#ffffff",e.fontSize=24,e}_createLevelSlider(){const e=new BABYLON.GUI.Slider("level_slider");return e.minimum=1,e.maximum=1,e.value=1,e.width="90%",e.height="32px",e.isThumbCircle=!0,e.borderColor="#000000",e.background="#7092A3",e.color="#c0c000",e.onValueChangedObservable.add(o=>{e.value=t(o),this.onNextLevelChanged.notify()}),e}_createSounds(){this._clickSound=this._screen.assets.getSound("click");const e=y.getOption("sound_effects_volume")/100;this._clickSound.setVolume(e)}_settings_onOptionChanged(e,t){"sound_effects_volume"===e&&this._clickSound.setVolume(t/100)}_playButton_onPointerDown(){this._clickSound.play()}_playButton_onPointerClick(){this.onPlay.notify()}_optionsButton_onPointerDown(){this._clickSound.play()}_optionsButton_onPointerClick(){this.onOptions.notify()}_helpButton_onPointerDown(){this._clickSound.play()}_helpButton_onPointerClick(){this.onHelp.notify()}}class P extends x{constructor(e){super(e),this._initCallbacks(),this._initEvents()}create(){this._createWidgets(),this._saveAlpha(),this._createSounds()}dispose(){this._ui.dispose(),this._disposeEvents()}_initCallbacks(){this._settings_onOptionChangedCallback=this._settings_onOptionChanged.bind(this),this._backButton_onPointerDownCallback=this._backButton_onPointerDown.bind(this),this._backButton_onPointerClickCallback=this._backButton_onPointerClick.bind(this)}_initEvents(){this.onBack=new m,y.onOptionChanged.add(this._settings_onOptionChangedCallback)}_disposeEvents(){y.onOptionChanged.remove(this._settings_onOptionChangedCallback)}_createWidgets(){this._ui=BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("options",!0,this._screen.scene),this._ui.addControl(this._createMainPanelBackground()),this._ui.addControl(this._createMainPanel()),this._ui.addControl(this._createBackButtonBackground()),this._ui.addControl(this._createBackButton())}_createMainPanelBackground(){const e=new BABYLON.GUI.Rectangle("background");return e.width="672px",e.height="464px",e.background="#000000",e.alpha=.5,e.thickness=0,e.cornerRadius=20,e}_createMainPanel(){const e=new BABYLON.GUI.StackPanel("main_panel");return e.width="672px",e.height="464px",e.addControl(this._createMovementPanel()),e.addControl(this._createAudioPanel()),e}_createMovementPanel(){const e=new BABYLON.GUI.StackPanel("movement_panel");return e.addControl(this._createMovementTitleLabel()),e.addControl(this._createMovementBodyPanel()),e}_createMovementTitleLabel(){const e=this._createTitleLabel("movement_title_label");return e.text="Movement",e}_createMovementBodyPanel(){const e=new BABYLON.GUI.StackPanel("movement_body_panel");return e.addControl(this._createForkliftSpeedPanel()),e.addControl(this._createRotationSpeedPanel()),e.addControl(this._createForksSpeedPanel()),e}_createForkliftSpeedPanel(){const e=new BABYLON.GUI.StackPanel("forklift_speed_panel");e.isVertical=!1;const t=this._createBodyLabel("forklift_speed_label");return t.width="320px",t.text="Forklift speed:",this._forkliftSpeedSlider=this._createSpeedSlider("forklift_speed_slider",4,e=>{y.setOption("forklift_speed",e)}),this._forkliftSpeedSlider.value=y.getOption("forklift_speed"),e.addControl(t),e.addControl(this._forkliftSpeedSlider),e}_createRotationSpeedPanel(){const e=new BABYLON.GUI.StackPanel("rotation_speed_panel");e.isVertical=!1;const t=this._createBodyLabel("rotation_speed_label");return t.width="320px",t.text="Rotation speed:",this._rotationSpeedSlider=this._createSpeedSlider("rotation_speed_slider",4,e=>{y.setOption("rotation_speed",e)}),this._rotationSpeedSlider.value=y.getOption("rotation_speed"),e.addControl(t),e.addControl(this._rotationSpeedSlider),e}_createForksSpeedPanel(){const e=new BABYLON.GUI.StackPanel("forks_speed_panel");e.isVertical=!1;const t=this._createBodyLabel("forks_speed_label");return t.width="320px",t.text="Forks speed:",this._forksSpeedSlider=this._createSpeedSlider("forks_speed_slider",4,e=>{y.setOption("forks_speed",e)}),this._forksSpeedSlider.value=y.getOption("forks_speed"),e.addControl(t),e.addControl(this._forksSpeedSlider),e}_createAudioPanel(){const e=new BABYLON.GUI.StackPanel("audio_panel");return e.addControl(this._createAudioTitleLabel()),e.addControl(this._createAudioBodyPanel()),e}_createAudioTitleLabel(){const e=this._createTitleLabel("audio_title_label");return e.text="Audio",e}_createAudioBodyPanel(){const e=new BABYLON.GUI.StackPanel("movement_body_panel");return e.addControl(this._createMusicVolumePanel()),e.addControl(this._createAmbientSoundVolumePanel()),e.addControl(this._createSoundEffectsVolumePanel()),e}_createMusicVolumePanel(){const e=new BABYLON.GUI.StackPanel("music_volume_panel");e.isVertical=!1;// label
const t=this._createBodyLabel("music_volume_label");return t.width="320px",t.text="Music:",this._musicVolumeSlider=this._createSoundSlider("music_volume_slider",100,e=>{y.setOption("music_volume",e)}),this._musicVolumeSlider.value=y.getOption("music_volume"),e.addControl(t),e.addControl(this._musicVolumeSlider),e}_createAmbientSoundVolumePanel(){const e=new BABYLON.GUI.StackPanel("ambient_sound_volume_panel");e.isVertical=!1;// label
const t=this._createBodyLabel("ambient_sound_volume_label");return t.width="320px",t.text="Ambient sound:",this._ambientSoundVolumeSlider=this._createSoundSlider("ambient_sound_volume_slider",100,e=>{y.setOption("ambient_sound_volume",e)}),this._ambientSoundVolumeSlider.value=y.getOption("ambient_sound_volume"),e.addControl(t),e.addControl(this._ambientSoundVolumeSlider),e}_createSoundEffectsVolumePanel(){const e=new BABYLON.GUI.StackPanel("sound_effects_volume_panel");e.isVertical=!1;// label
const t=this._createBodyLabel("sound_effects_volume_label");return t.width="320px",t.text="Sound effects:",this._soundEffectsVolumeSlider=this._createSoundSlider("sound_effects_volume_slider",100,e=>{y.setOption("sound_effects_volume",e)}),this._soundEffectsVolumeSlider.value=y.getOption("sound_effects_volume"),e.addControl(t),e.addControl(this._soundEffectsVolumeSlider),e}_createBackButtonBackground(){const e=new BABYLON.GUI.Rectangle("background");return e.width="152px",e.height="56px",e.top="8px",e.left="8px",e.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP,e.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,e.background="#000000",e.alpha=.5,e.thickness=0,e.cornerRadius=20,e}_createBackButton(){const e=this._createButton("back_button","Back");return e.width="136px",e.top="16px",e.left="16px",e.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP,e.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,e.onPointerDownObservable.add(this._backButton_onPointerDownCallback),e.onPointerClickObservable.add(this._backButton_onPointerClickCallback),e}_createTitleLabel(e){const t=new BABYLON.GUI.TextBlock(e);return t.height="96px",t.fontFamily="Native Alien Extended",t.color="#7092A3",t.fontSize=48,t}_createBodyLabel(e){const t=new BABYLON.GUI.TextBlock(e);return t.height="40px",t.fontFamily="Native Alien Extended",t.color="#ffffff",t.fontSize=24,t}_createSpeedSlider(e,o,n){const a=new BABYLON.GUI.Slider(e);return a.minimum=0,a.maximum=o,a.value=0,a.width="288px",a.height="32px",a.isThumbCircle=!0,a.borderColor="#000000",a.background="#7092A3",a.color="#c0c000",a.onValueChangedObservable.add(e=>{a.value=t(e),n(a.value)}),a}_createSoundSlider(e,o,n){const a=new BABYLON.GUI.Slider(e);return a.minimum=0,a.maximum=o,a.value=0,a.width="288px",a.height="32px",a.isThumbCircle=!0,a.borderColor="#000000",a.background="#7092A3",a.color=a.background,a.onValueChangedObservable.add(e=>{a.value=t(e),a.color=0===a.value?a.background:"#c0c000",n(a.value)}),a}_createButton(e,t){const o=BABYLON.GUI.Button.CreateSimpleButton(e,t);return o.fontFamily="Native Alien Extended",o.fontSize=18,o.height="40px",o.color="#000000",o.background="#7092A3",o.cornerRadius=10,o}_createSounds(){this._clickSound=this._screen.assets.getSound("click");const e=y.getOption("sound_effects_volume")/100;this._clickSound.setVolume(e)}_settings_onOptionChanged(e,t){"sound_effects_volume"===e&&this._clickSound.setVolume(t/100)}_backButton_onPointerDown(){this._clickSound.play()}_backButton_onPointerClick(){this.onBack.notify()}}class L extends x{constructor(e){super(e),this._initCallbacks(),this._initEvents()}create(){this._createWidgets(),this._saveAlpha(),this._createSounds()}dispose(){this._ui.dispose(),this._disposeEvents()}_initCallbacks(){this._settings_onOptionChangedCallback=this._settings_onOptionChanged.bind(this),this._backButton_onPointerDownCallback=this._backButton_onPointerDown.bind(this),this._backButton_onPointerClickCallback=this._backButton_onPointerClick.bind(this)}_initEvents(){this.onBack=new m,y.onOptionChanged.add(this._settings_onOptionChangedCallback)}_disposeEvents(){y.onOptionChanged.remove(this._settings_onOptionChangedCallback)}_createWidgets(){this._ui=BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("help",!0,this._screen.scene),this._ui.addControl(this._createMainPanelBackground()),this._ui.addControl(this._createMainPanel()),this._ui.addControl(this._createBackButtonBackground()),this._ui.addControl(this._createBackButton())}_createMainPanelBackground(){const e=new BABYLON.GUI.Rectangle("background");return e.width="592px",e.height="592px",e.background="#000000",e.alpha=.5,e.thickness=0,e.cornerRadius=20,e}_createMainPanel(){const e=new BABYLON.GUI.StackPanel("main_panel");return e.width="592px",e.height="592px",e.addControl(this._createInstructionsPanel()),e.addControl(this._createControlsPanel()),e.addControl(this._createShortcutsPanel()),e}_createInstructionsPanel(){const e=new BABYLON.GUI.StackPanel("instructions_panel");return e.addControl(this._createInstructionsTitleLabel()),e.addControl(this._createInstructionsBodyLabel()),e}_createInstructionsTitleLabel(){const e=this._createTitleLabel("instructions_title_label");return e.text="Instructions",e}_createInstructionsBodyLabel(){const e=this._createBodyLabel("instructions_body_label");return e.height="80px",e.text="Stack crates on goals and\nleave no empty goals",e}_createControlsPanel(){const e=new BABYLON.GUI.StackPanel("controls_panel");return e.addControl(this._createControlsTitleLabel()),e.addControl(this._createControlsBodyLabel()),e}_createControlsTitleLabel(){const e=this._createTitleLabel("controls_title_label");return e.text="Controls",e}_createControlsBodyLabel(){const e=this._createBodyLabel("controls_body_label");return e.height="80px",e.text="Move forklift with arrow keys\nMove forks with 1-2-3 keys",e}_createShortcutsPanel(){const e=new BABYLON.GUI.StackPanel("shortcuts_panel");return e.addControl(this._createShortcutsTitleLabel()),e.addControl(this._createShortcutsBodyLabel()),e}_createShortcutsTitleLabel(){const e=this._createTitleLabel("shortcuts_title_label");return e.text="Shortcuts",e}_createShortcutsBodyLabel(){const e=this._createBodyLabel("shortcuts_body_label");return e.height="120px",e.text="Esc: abort level\nR: restart level\nSpace: next level",e}_createBackButtonBackground(){const e=new BABYLON.GUI.Rectangle("background");return e.width="152px",e.height="56px",e.top="8px",e.left="8px",e.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP,e.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,e.background="#000000",e.alpha=.5,e.thickness=0,e.cornerRadius=20,e}_createBackButton(){const e=this._createButton("back_button","Back");return e.width="136px",e.top="16px",e.left="16px",e.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP,e.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,e.onPointerDownObservable.add(this._backButton_onPointerDownCallback),e.onPointerClickObservable.add(this._backButton_onPointerClickCallback),e}_createTitleLabel(e){const t=new BABYLON.GUI.TextBlock(e);return t.height="96px",t.fontFamily="Native Alien Extended",t.color="#7092A3",t.fontSize=48,t}_createBodyLabel(e){const t=new BABYLON.GUI.TextBlock(e);return t.fontFamily="Native Alien Extended",t.color="#ffffff",t.fontSize=24,t}_createButton(e,t){const o=BABYLON.GUI.Button.CreateSimpleButton(e,t);return o.fontFamily="Native Alien Extended",o.fontSize=18,o.height="40px",o.color="#000000",o.background="#7092A3",o.cornerRadius=10,o}_createSounds(){this._clickSound=this._screen.assets.getSound("click");const e=y.getOption("sound_effects_volume")/100;this._clickSound.setVolume(e)}_settings_onOptionChanged(e,t){"sound_effects_volume"===e&&this._clickSound.setVolume(t/100)}_backButton_onPointerDown(){this._clickSound.play()}_backButton_onPointerClick(){this.onBack.notify()}}class I{constructor(e){this._engine=e,this._initScene(),this._initPostProcess()}dispose(){this._disposePostProcess(),this._disposeScene()}_initScene(){this._scene=new BABYLON.Scene(this._engine)}_initPostProcess(){this._fadePostProcess=new BABYLON.PostProcess("fade_in","./assets/shaders/fade",["fadeLevel"],null,1,null,0,this._engine)}_disposePostProcess(){this._fadePostProcess.dispose()}_disposeScene(){this._scene.dispose(),this._scene=null}_fadeIn(e,t=()=>{}){let o=null,n=0;const i=()=>{const t=Date.now()-o;n=a(t/e,1)};this._fadePostProcess.onApply=e=>{o||(o=Date.now(),this._scene.registerBeforeRender(i)),e.setFloat("fadeLevel",n)},this._fadePostProcess.onAfterRender=()=>{1===n&&(this._scene.unregisterBeforeRender(i),this._scene.activeCamera.detachPostProcess(this._fadePostProcess),t())},this._scene.activeCamera.attachPostProcess(this._fadePostProcess)}_fadeOut(e,t=()=>{}){let o=null,a=1;const i=()=>{const t=Date.now()-o;a=n(1-t/e,0)};this._fadePostProcess.onApply=e=>{o||(o=Date.now(),this._scene.registerBeforeRender(i)),e.setFloat("fadeLevel",a)},this._fadePostProcess.onAfterRender=()=>{0===a&&(this._scene.unregisterBeforeRender(i),this._scene.activeCamera.detachPostProcess(this._fadePostProcess),t())},this._scene.activeCamera.attachPostProcess(this._fadePostProcess)}}class A extends C{constructor(e,t){super(t),this._entity=e,this._entity.figure=this}dispose(){super.dispose()}}class w extends A{constructor(e,t){super(e,t),this._createMesh()}initShadows(){this._mesh.receiveShadows=!0}_createMesh(){this._mesh=this._screen.assets.createMesh("floor"),this._initTransform(),this._initMaterials()}_initTransform(){this._mesh.rotationQuaternion=BABYLON.Quaternion.Identity()}_initMaterials(){this._mesh.material.ambientColor.set(.15,.15,.15)}}class B extends A{constructor(e,t){super(e,t),this._initImages(),this._createMesh()}initShadows(){this._mesh.receiveShadows=!0}_initImages(){this._baseImage=this._screen.assets.getImage("goal_base"),this._decalImage=this._screen.assets.getImage("goal_decal"),this._scrapesMask=this._screen.assets.getImage("scrapes_mask")}_createMesh(){this._mesh=this._screen.assets.createMesh("goal"),this._mesh.material=this._mesh.material.clone(),this._initTransform(),this._initMaterials()}_initTransform(){this._mesh.rotationQuaternion=BABYLON.Quaternion.Identity()}_initMaterials(){const e=this._mesh.material;e.albedoTexture=this._createAlbedoTexture(),e.ambientColor.set(.15,.15,.15)}_createAlbedoTexture(){const{width:e,height:t}=this._baseImage,o=new BABYLON.DynamicTexture("",{width:e,height:t},this._screen.scene),n=o.getContext();n.clearRect(0,0,e,t),n.save(),n.scale(1,-1),n.drawImage(this._decalImage,0,-t+1),n.globalCompositeOperation="destination-out";const a=128*(this._entity.location.c%(e/128)),i=128*(this._entity.location.r%(t/128));return n.save(),n.globalAlpha=.6,n.drawImage(this._scrapesMask,a,i,128,128,0,-512,512,512),n.restore(),n.globalCompositeOperation="color-burn",n.drawImage(this._baseImage,0,-t+1),n.restore(),o.update(),o}}class M extends A{constructor(e,t){super(e,t),this._isLifted=!1,this._isOnGoal=!1,this._createMesh(),this._createSounds(),this._updateGlow(),this._initCallbacks(),this._initEvents()}initShadows(e){e.addShadowCaster(this._mesh),this._mesh.receiveShadows=!0}dispose(){this._disposeEvents(),super.dispose()}get parentMesh(){return super.parentMesh}set parentMesh(e){e?this._onPick(e):this._onDrop(),this._updateGlow(),super.parentMesh=e}_initCallbacks(){this._settings_onOptionChangedCallback=this._settings_onOptionChanged.bind(this)}_initEvents(){y.onOptionChanged.add(this._settings_onOptionChangedCallback)}_disposeEvents(){y.onOptionChanged.remove(this._settings_onOptionChangedCallback)}_createMesh(){this._mesh=this._screen.assets.createMesh("crate"),this._mesh.material=this._mesh.material.clone(),this._initTransform(),this._initMaterials()}_initTransform(){const{r:e,c:t,h:o}=this._entity.location,n=["n","e","s","w"][(e+t+o)%4];this._mesh.rotationQuaternion=BABYLON.Quaternion.Orientation(n)}_initMaterials(){this._mesh.material.ambientColor.set(.5,.5,.5)}_createSounds(){this._dropSound=this._screen.assets.getSound("drop");const e=y.getOption("sound_effects_volume")/100;this._dropSound.setVolume(e)}_onPick(e){const t=e.getWorldMatrix(),o=this._mesh.getWorldMatrix(),n=o.multiply(BABYLON.Matrix.Invert(t));n.decompose(this._mesh.scaling,this._mesh.rotationQuaternion,this._mesh.position),this._entity.isLifted()&&(this._isLifted=!0,this._mesh.position.y+=.05)}_onDrop(){const e=this._mesh.computeWorldMatrix(!0);e.decompose(this._mesh.scaling,this._mesh.rotationQuaternion,this._mesh.position),this._isLifted&&(this._isLifted=!1,this._mesh.position.y-=.05,this._dropSound.play())}_updateGlow(){const e=this._entity.isOnGoal();if(e!==this._isOnGoal){this._isOnGoal=e;const t=this._createGlowAnimation(e);this._mesh.animations=[],this._mesh.animations.push(t);const o=this._mesh.getScene();o.beginAnimation(this._mesh,1)}}_createGlowAnimation(){const e=[];this._isOnGoal?(e.push({frame:0,value:this._mesh.material.emissiveColor}),e.push({frame:10,value:new BABYLON.Color3(.18,.14,0)})):(e.push({frame:0,value:this._mesh.material.emissiveColor}),e.push({frame:5,value:new BABYLON.Color3(0,0,0)}));const t=new BABYLON.Animation("glow","material.emissiveColor",30,BABYLON.Animation.ANIMATIONTYPE_COLOR3,BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);return t.setKeys(e),t}_settings_onOptionChanged(e,t){"sound_effects_volume"===e&&this._dropSound.setVolume(t/100)}}class R{constructor(e,t,o,n,a,i=0){this._mesh=e,this._attribute=t,this._lerp=o,this._keys=n,this._fps=a,this._elapsed=0,this._index=0,this.onFinished=new m,0<i&&this.update(i)}update(e){this._elapsed+=e;let t=this._elapsed*this._fps/1e3;for(;t>=this._nextKey().frame;)if(!this._advance()){t=this._nextKey().frame,this._updateAttribute(t);const e=this._elapsed-1e3*t/this._fps;return void this.onFinished.notify(e)}this._updateAttribute(t)}_updateAttribute(e){const t=this._prevKey(),o=this._nextKey(),n=e/(o.frame-t.frame);this._mesh[this._attribute]=this._lerp(t.value,o.value,n)}_prevKey(){return this._keys[this._index]}_nextKey(){return this._keys[this._index+1]}_advance(){return this._index!==this._keys.length-2&&(++this._index,!0)}}class T extends A{constructor(e,t){super(e,t),this._idle=!0,this._animations=[],this._carries=new Map,this._initCallbacks(),this._initEvents()}dispose(){this._disposeEvents(),super.dispose()}get idle(){return this._idle}set idle(e){this._idle=e,this._idle&&this.onIdle.notify()}_moveBy(e,t,o,{fps:n=30,group:a="default",onFinished:i=()=>{}}){this.idle=!1;const l=e.position,_=l.add(t),s=this._carries.get(a)||0,r=new R(e,"position",BABYLON.Vector3.Lerp,[{frame:0,value:l},{frame:o,value:_}],n,s);r.onFinished.add(e=>{this._carries.set(a,e);const t=this._animations.indexOf(r);this._animations.splice(t,1),i(),0===this._animations.length&&(this.idle=!0)}),this._animations.push(r)}_rotateBy(e,t,o,{fps:n=30,group:a="default",onFinished:i=()=>{}}){this.idle=!1;const l=e.rotationQuaternion,_=l.multiply(t),s=this._carries.get(a)||0,r=new R(e,"rotationQuaternion",BABYLON.Quaternion.Slerp,[{frame:0,value:l},{frame:o,value:_}],n,s);r.onFinished.add(e=>{this._carries.set(a,e);const t=this._animations.indexOf(r);this._animations.splice(t,1),i(),0===this._animations.length&&(this.idle=!0)}),this._animations.push(r)}_initCallbacks(){this._scene_onBeforeRenderCallback=this._scene_onBeforeRender.bind(this)}_initEvents(){this.onIdle=new m,this._screen.scene.registerBeforeRender(this._scene_onBeforeRenderCallback)}_disposeEvents(){this._screen.scene.unregisterBeforeRender(this._scene_onBeforeRenderCallback)}_scene_onBeforeRender(){this._carries.clear();const e=this._screen.scene.getEngine().getDeltaTime();for(const t of[...this._animations])// loop on a copy
t.update(e)}}class E extends T{constructor(e,t){// calls _initCallbacks(), _initEvents()
super(e,t),this._createMesh(),this._createRoot()}dispose(){this._disposeRoot(),super.dispose()}initShadows(e){e.addShadowCaster(this._mesh)}_initCallbacks(){super._initCallbacks(),this._entity_onMoveForwardCallback=this._entity_onMoveForward.bind(this),this._entity_onMoveBackwardCallback=this._entity_onMoveBackward.bind(this),this._entity_onRotateCWCallback=this._entity_onRotateCW.bind(this),this._entity_onRotateCCWCallback=this._entity_onRotateCCW.bind(this),this._entity_onForksMoveCallback=this._entity_onForksMove.bind(this)}_initEvents(){super._initEvents(),this._entity.onMoveForward.add(this._entity_onMoveForwardCallback),this._entity.onMoveBackward.add(this._entity_onMoveBackwardCallback),this._entity.onRotateCW.add(this._entity_onRotateCWCallback),this._entity.onRotateCCW.add(this._entity_onRotateCCWCallback),this._entity.onForksMove.add(this._entity_onForksMoveCallback)}_disposeEvents(){this._entity.onMoveForward.remove(this._entity_onMoveForwardCallback),this._entity.onMoveBackward.remove(this._entity_onMoveBackwardCallback),this._entity.onRotateCW.remove(this._entity_onRotateCWCallback),this._entity.onRotateCCW.remove(this._entity_onRotateCCWCallback),this._entity.onForksMove.remove(this._entity_onForksMoveCallback),super._disposeEvents()}_createMesh(){this._mesh=this._screen.assets.createMesh("forklift");const e=this._mesh.getChildMeshes(!0);this._forksMesh=e[0],this._mastMesh=e[1],this._tractorLeftMesh=e[2],this._tractorRightMesh=e[3],this._initTransform(),this._initMaterials()}_initTransform(){this._mesh.rotationQuaternion=BABYLON.Quaternion.Orientation(this._entity.orientation),this._tractorLeftMesh.rotationQuaternion=BABYLON.Quaternion.Identity(),this._tractorRightMesh.rotationQuaternion=BABYLON.Quaternion.Identity()}_initMaterials(){this._forksMesh.material.ambientColor.set(1,1,1),this._mastMesh.material.ambientColor.set(1,1,1),this._tractorLeftMesh.material.ambientColor.set(1,1,1),this._tractorRightMesh.material.ambientColor.set(1,1,1)}_createRoot(){this._root=new BABYLON.TransformNode("forklift_root"),this._root.rotationQuaternion=BABYLON.Quaternion.Identity(),this._root.parent=this._mesh.parent,this._mesh.parent=this._root}_disposeRoot(){this._root.dispose()}_updateRoot(){const e=BABYLON.Matrix.Compose(this._root.scaling,this._root.rotationQuaternion,this._root.position),t=BABYLON.Matrix.Compose(this._mesh.scaling,this._mesh.rotationQuaternion,this._mesh.position),o=t.multiply(e);o.decompose(this._root.scaling,this._root.rotationQuaternion,this._root.position),this._mesh.position.set(0,0,0),this._mesh.rotationQuaternion=BABYLON.Quaternion.Identity(),this._mesh.scaling=BABYLON.Vector3.One()}_moveForklift(e,t,o){this._updateRoot(),this._moveBy(this._mesh,e,t,{group:"forklift",onFinished:o})}_rotateForklift(e,t){this._rotateBy(this._mesh,e,t,{group:"forklift"})}_rotateTractor(e,t,o){const n=BABYLON.Vector3.Right(),a=BABYLON.Quaternion.RotationAxis(n,e),i=BABYLON.Quaternion.RotationAxis(n,t);this._rotateBy(this._tractorLeftMesh,a,o,{group:"tractor_left"}),this._rotateBy(this._tractorRightMesh,i,o,{group:"tractor_right"})}_moveForks(e,t){this._moveBy(this._forksMesh,e,t,{group:"forklift"})}_entity_onMoveForward(e){const t=BABYLON.Vector3.Forward(),o=9-y.getOption("forklift_speed");this._moveForklift(t,o,()=>{e&&(this._mesh.computeWorldMatrix(!0),this._forksMesh.computeWorldMatrix(!0),e.figure.parentMesh=this._forksMesh)}),this._rotateTractor(Math.PI,Math.PI,o)}_entity_onMoveBackward(e){e&&(this._mesh.computeWorldMatrix(!0),this._forksMesh.computeWorldMatrix(!0),e.figure.parentMesh=null);const t=BABYLON.Vector3.Forward().negate(),o=9-y.getOption("forklift_speed");this._moveForklift(t,o),this._rotateTractor(-i,-i,o)}_entity_onRotateCW(){this._updateRoot();const e=BABYLON.Vector3.Up(),t=BABYLON.Quaternion.CW(e),o=8-y.getOption("rotation_speed");this._rotateForklift(t,o),this._rotateTractor(i/2,-(i/2),o)}_entity_onRotateCCW(){this._updateRoot();const e=BABYLON.Vector3.Up(),t=BABYLON.Quaternion.CCW(e),o=8-y.getOption("rotation_speed");this._rotateForklift(t,o),this._rotateTractor(-(i/2),i/2,o)}_entity_onForksMove(e,t){const o=new BABYLON.Vector3(0,t-e,0),n=7-y.getOption("forks_speed");this._moveForks(o,n)}}class N extends x{constructor(e){super(e),this._initCallbacks(),this._initEvents()}create(){this._createWidgets(),this._saveAlpha(),this._createSounds()}dispose(){this._ui.dispose(),this._disposeEvents()}set level(e){this._levelLabel.text="Level: "+e}_initCallbacks(){this._settings_onOptionChangedCallback=this._settings_onOptionChanged.bind(this),this._abortButton_onPointerDownCallback=this._abortButton_onPointerDown.bind(this),this._abortButton_onPointerClickCallback=this._abortButton_onPointerClick.bind(this),this._restartButton_onPointerDownCallback=this._restartButton_onPointerDown.bind(this),this._restartButton_onPointerClickCallback=this._restartButton_onPointerClick.bind(this)}_initEvents(){this.onAbort=new m,this.onRestart=new m,y.onOptionChanged.add(this._settings_onOptionChangedCallback)}_disposeEvents(){y.onOptionChanged.remove(this._settings_onOptionChangedCallback)}_createWidgets(){this._ui=BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("level",!0,this._screen.scene),this._ui.addControl(this._createPanelBackground()),this._ui.addControl(this._createPanel())}_createPanelBackground(){const e=new BABYLON.GUI.Rectangle("background");return e.width="152px",e.height="144px",e.top="8px",e.left="8px",e.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,e.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP,e.background="#000000",e.alpha=.5,e.thickness=0,e.cornerRadius=10,e}_createPanel(){const e=new BABYLON.GUI.StackPanel("panel");return e.width="152px",e.height="144px",e.top="8px",e.left="8px",e.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,e.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP,this._levelLabel=this._createLevelLabel(),e.addControl(this._levelLabel),e.addControl(this._createAbortButton()),e.addControl(this._createRestartButton()),e}_createLevelLabel(){const e=new BABYLON.GUI.TextBlock("level_label");return e.height="40px",e.top="8px",e.bottom="8px",e.fontFamily="Native Alien Extended",e.color="#ffffff",e.fontSize=24,e.text="",e}_createAbortButton(){const e=this._createButton("abort_button","Abort");return e.onPointerDownObservable.add(this._abortButton_onPointerDownCallback),e.onPointerClickObservable.add(this._abortButton_onPointerClickCallback),e}_createRestartButton(){const e=this._createButton("restart_button","Restart");return e.onPointerDownObservable.add(this._restartButton_onPointerDownCallback),e.onPointerClickObservable.add(this._restartButton_onPointerClickCallback),e}_createButton(e,t){const o=BABYLON.GUI.Button.CreateSimpleButton(e,t);return o.fontFamily="Native Alien Extended",o.fontSize=18,o.height="48px",o.paddingTop="8px",o.paddingLeft="8px",o.paddingRight="8px",o.color="#000000",o.background="#7092A3",o.cornerRadius=10,o}_createSounds(){this._clickSound=this._screen.assets.getSound("click");const e=y.getOption("sound_effects_volume")/100;this._clickSound.setVolume(e)}_settings_onOptionChanged(e,t){"sound_effects_volume"===e&&this._clickSound.setVolume(t/100)}_abortButton_onPointerDown(){this._clickSound.play()}_abortButton_onPointerClick(){this.onAbort.notify()}_restartButton_onPointerDown(){this._clickSound.play()}_restartButton_onPointerClick(){this.onRestart.notify()}}class G extends x{constructor(e){super(e),this._initCallbacks(),this._initEvents()}create(){this._createWidgets(),this._saveAlpha(),this._createSounds()}dispose(){this._ui.dispose(),this._disposeEvents()}set level(e){this._messageLabel.text="Level "+e+" solved!"}set moves(e){this._movesLabel.text="Moves: "+e}set time(e){const t=o(e/60)+"",n=(o(e%60)+"").padStart(2,"0");this._timeLabel.text="Time: "+t+":"+n}_initCallbacks(){this._settings_onOptionChangedCallback=this._settings_onOptionChanged.bind(this),this._nextButton_onPointerDownCallback=this._nextButton_onPointerDown.bind(this),this._nextButton_onPointerClickCallback=this._nextButton_onPointerClick.bind(this)}_initEvents(){this.onNext=new m,y.onOptionChanged.add(this._settings_onOptionChangedCallback)}_disposeEvents(){y.onOptionChanged.remove(this._settings_onOptionChangedCallback)}_createWidgets(){this._ui=BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("level_solved",!0,this._screen.scene),this._ui.addControl(this._createPanelBackground()),this._ui.addControl(this._createPanel())}_createPanelBackground(){const e=new BABYLON.GUI.Rectangle("background");return e.width="152px",e.height="208px",e.top="8px",e.left="8px",e.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,e.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP,e.background="#000000",e.alpha=.5,e.thickness=0,e.cornerRadius=10,e}_createPanel(){const e=new BABYLON.GUI.StackPanel("panel");return e.width="152px",e.height="208px",e.top="8px",e.left="8px",e.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,e.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP,this._messageLabel=this._createMessageLabel(),e.addControl(this._messageLabel),this._movesLabel=this._createMovesLabel(),e.addControl(this._movesLabel),this._timeLabel=this._createTimeLabel(),e.addControl(this._timeLabel),e.addControl(this._createNextButton()),e}_createMessageLabel(){const e=new BABYLON.GUI.TextBlock("message_label");return e.height="80px",e.top="8px",e.fontFamily="Native Alien Extended",e.color="#ffff00",e.fontSize=24,e.text="",e.textWrapping=!0,e}_createMovesLabel(){const e=new BABYLON.GUI.TextBlock("moves_label");return e.height="36px",e.top="16px",e.fontFamily="Native Alien Extended",e.color="#ffffff",e.fontSize=18,e.text="",e}_createTimeLabel(){const e=new BABYLON.GUI.TextBlock("time_label");return e.height="36px",e.top="16px",e.fontFamily="Native Alien Extended",e.color="#ffffff",e.fontSize=18,e.text="",e}_createNextButton(){const e=this._createButton("next_button","Next");return e.onPointerDownObservable.add(this._nextButton_onPointerDownCallback),e.onPointerClickObservable.add(this._nextButton_onPointerClickCallback),e}_createButton(e,t){const o=BABYLON.GUI.Button.CreateSimpleButton(e,t);return o.fontFamily="Native Alien Extended",o.fontSize=18,o.height="48px",o.paddingTop="8px",o.paddingLeft="8px",o.paddingRight="8px",o.color="#000000",o.background="#7092A3",o.cornerRadius=10,o}_createSounds(){this._clickSound=this._screen.assets.getSound("click");const e=y.getOption("sound_effects_volume")/100;this._clickSound.setVolume(e)}_settings_onOptionChanged(e,t){"sound_effects_volume"===e&&this._clickSound.setVolume(t/100)}_nextButton_onPointerDown(){this._clickSound.play()}_nextButton_onPointerClick(){this.onNext.notify()}}class U{constructor(e){this._scene=e,this._keysDown=new Set,this._actions=null,this._onKeyboardCallback=this._scene_onKeyboard.bind(this)}track(e){this._actions=e,this._scene.onKeyboardObservable.add(this._onKeyboardCallback)}untrack(){this._scene.onKeyboardObservable.removeCallback(this._onKeyboardCallback),this._actions=null,this._keysDown.clear()}performActions(){for(const e of this._keysDown)this._actions.get(e)()}_scene_onKeyboard(e){if(e.type===BABYLON.KeyboardEventTypes.KEYDOWN){const t=e.event.keyCode;if(!this._actions.has(t))return;if(e.event.preventDefault(),this._keysDown.has(t))return;this._keysDown.add(t),this._actions.get(t)()}else if(e.type===BABYLON.KeyboardEventTypes.KEYUP){const t=e.event.keyCode;this._keysDown.delete(t)}}}const V={meshes:["figures","environment"],images:["warehouse_base.png","digits.png","scrapes_mask.png","goal_base.png","goal_decal.png"],fonts:["Native Alien Extended"],sounds:["click.mp3","drop.mp3","level_solved.mp3","game_solved.mp3"]};class F extends I{constructor(e){super(e),this._assets=new h(this._scene),this._ui=new N(this),this._uiLevelSolved=new G(this),this._keyboard=new U(this._scene),this._level=null,this._figures=[],this._forklift=null,this._startTime=null,this._playbackMoves=[],this._initCallbacks(),this._initEvents()}initAsync(){return new Promise(async e=>{await this._assets.loadAsync(V),this._createScene(),this._createUI(),e()})}dispose(){this._disposeUI(),this._disposeEvents(),super.dispose()}_initCallbacks(){this._engine_onRenderLoopCallback=this._engine_onRenderLoop.bind(this),this._settings_onOptionChangedCallback=this._settings_onOptionChanged.bind(this),this._forklift_onIdleCallback=this._forklift_onIdle.bind(this),this._ui_onAbortCallback=this._ui_onAbort.bind(this),this._ui_onRestartCallback=this._ui_onRestart.bind(this),this._uiLevelSolved_onNextCallback=this._uiLevelSolved_onNext.bind(this)}_initEvents(){this.onAbort=new m,this.onRestart=new m,this.onPlayback=new m,this.onLevelSolved=new m,this.onNext=new m,y.onOptionChanged.add(this._settings_onOptionChangedCallback),this._ui.onAbort.add(this._ui_onAbortCallback),this._ui.onRestart.add(this._ui_onRestartCallback),this._uiLevelSolved.onNext.add(this._uiLevelSolved_onNextCallback)}_disposeUI(){this._ui.dispose(),this._uiLevelSolved.dispose()}_disposeFigures(){this._forklift.onIdle.remove(this._forklift_onIdleCallback),this._forklift=null;for(const e of this._figures)e.dispose();this._figures=[]}_disposeEvents(){y.onOptionChanged.remove(this._settings_onOptionChangedCallback),this._ui.onAbort.remove(this._ui_onAbortCallback),this._ui.onRestart.remove(this._ui_onRestartCallback),this._uiLevelSolved.onNext.remove(this._uiLevelSolved_onNextCallback)}get scene(){return this._scene}get assets(){return this._assets}runFirst(e){this._level=e,this._createFigures(),this._warehouseAspect.level=this._level.number,this._engine.runRenderLoop(this._engine_onRenderLoopCallback),this._fadeIn(200,()=>{this._ui.isVisible=!0,this._ui.level=this._level.number,this._ui.fadeIn(200,()=>{this._ui.isEnabled=!0,this._trackKeyboardOnRun(),this._startTime=Date.now()})})}runNext(e){this._untrackKeyboard(),this._uiLevelSolved.isEnabled=!1,this._uiLevelSolved.fadeOut(200,()=>{this._uiLevelSolved.isVisible=!1,this._fadeOut(200,()=>{this._stopPlayback(),this._disposeFigures(),this._level.dispose(),this._level=e,this._createFigures(),this._warehouseAspect.level=this._level.number,this._engine.runRenderLoop(this._engine_onRenderLoopCallback),this._fadeIn(200,()=>{this._ui.isVisible=!0,this._ui.level=this._level.number,this._ui.fadeIn(200,()=>{this._ui.isEnabled=!0,this._trackKeyboardOnRun(),this._startTime=Date.now()})})})})}abort(e=()=>{}){this._untrackKeyboard(),this._ui.isEnabled=!1,this._ui.fadeOut(200,()=>{this._ui.isVisible=!1,this._fadeOut(200,()=>{this._engine.stopRenderLoop(this._engine_onRenderLoopCallback),this._stopPlayback(),this._disposeFigures(),this._level.dispose(),this._level=null,e()})})}restart(){this._untrackKeyboard(),this._ui.isEnabled=!1,this._fadeOut(200,()=>{this._stopPlayback(),this._disposeFigures(),this._level.reset(),this._createFigures(),this._fadeIn(200,()=>{this._ui.isEnabled=!0,this._trackKeyboardOnRun(),this._startTime=Date.now()})})}playback(){this._untrackKeyboard(),this._ui.isEnabled=!1,this._fadeOut(200,()=>{this._disposeFigures(),this._level.reset(),this._createFigures(),this._fadeIn(200,()=>{this._ui.isEnabled=!0,this._trackKeyboardOnPlayback(),this._startTime=Date.now(),this._startPlayback()})})}handleLevelSolved(){this._untrackKeyboard(),this._ui.isEnabled=!1,this._ui.fadeOut(200,()=>{this._ui.isVisible=!1,this._uiLevelSolved.level=this._level.number,this._uiLevelSolved.moves=this._level.moves.length,this._uiLevelSolved.time=(Date.now()-this._startTime)/1e3,this._uiLevelSolved.isVisible=!0,this._levelSolvedSound.play(),this._uiLevelSolved.fadeIn(200,()=>{this._uiLevelSolved.isEnabled=!0,this._trackKeyboardOnLevelSolved()})})}handleGameSolved(e=()=>{}){this._untrackKeyboard(),this._uiLevelSolved.isEnabled=!1,this._uiLevelSolved.fadeOut(200,()=>{this._uiLevelSolved.isVisible=!1,this._fadeOut(2500,()=>{this._disposeFigures(),this._level.dispose(),this._level=null,this._warehouseAspect.isVisible=!1,this._fadeIn(2500,()=>{this._gameSolvedSound.onEndedObservable.addOnce(()=>{window.setTimeout(()=>{this._fadeOut(2500,()=>{this._warehouseAspect.isVisible=!0,e()})},2500)}),this._gameSolvedSound.play()})})})}_createScene(){this._scene.ambientColor.set(.9,.9,.9),this._createSpace(),this._createWarehouse(),this._createLights(),this._createShadowGenerator(),this._createCamera(),this._createSounds()}_createSpace(){this._spaceAspect=new S(this),this._spaceAspect.position.set(0,0,0)}_createWarehouse(){this._warehouseAspect=new f(this),this._warehouseAspect.position.set(0,2.8,0)}_createLights(){// light1
const e=new BABYLON.Vector3(0,14,0);this._light1=new BABYLON.PointLight("light1",e,this._scene),this._light1.intensity=750,this._light1.shadowMinZ=9,this._light1.shadowMaxZ=14}_createShadowGenerator(){this._shadowGenerator=new BABYLON.ShadowGenerator(1024,this._light1),this._shadowGenerator.usePercentageCloserFiltering=!0,this._shadowGenerator.setDarkness(.88)}_createCamera(){const e=new BABYLON.Vector3(0,3,0);this._camera1=new BABYLON.ArcRotateCamera("camera1",-(i/2),i/9,10,e,this._scene)}_createSounds(){{this._levelSolvedSound=this._assets.getSound("level_solved");const e=y.getOption("sound_effects_volume")/100;this._levelSolvedSound.setVolume(e)}{this._gameSolvedSound=this._assets.getSound("game_solved");const e=y.getOption("sound_effects_volume")/100;this._gameSolvedSound.setVolume(e)}}_createUI(){this._ui.create(),this._ui.isVisible=!1,this._ui.isEnabled=!1,this._ui.alpha=0,this._createLevelSolvedUI()}_createLevelSolvedUI(){this._uiLevelSolved.create(),this._uiLevelSolved.isVisible=!1,this._uiLevelSolved.isEnabled=!1,this._uiLevelSolved.alpha=0}_createFigures(){console.assert(0===this._figures.length);const e=this._computeCenter(),t=this._level.grid;for(let o=0,n=t.getRowCount();o<n;++o)for(let n=0,a=t.getColumnCount(o);n<a;++n)for(let a=0,i=t.getHeight(o,n);a<i;++a){const i=t.getRCH(o,n,a),l=this._createFigure(i);l&&(l.position=BABYLON.Vector3.fromLocationRCH(o-e.r,n-e.c,a),l.initShadows(this._shadowGenerator),this._figures.push(l))}}_computeCenter(){const e=this._level.grid,t=e.getRowCount();let o=0;for(let a=0;a<t;++a)o=n(o,e.getColumnCount(a));const a=(o-1)/2;return new _((t-1)/2,a,2)}_createFigure(e){switch(e.constructor){case p:return new w(e,this);case r:return new B(e,this);case d:return new M(e,this);case k:return console.assert(!this._forklift),this._forklift=new E(e,this),this._forklift.onIdle.add(this._forklift_onIdleCallback),this._forklift;default:}}_engine_onRenderLoop(){this._scene.render()}_trackKeyboardOnRun(){this._keyboard.track(new Map([[38,()=>{this._forklift.idle&&this._level.move("n")}],[39,()=>{this._forklift.idle&&this._level.move("e")}],[40,()=>{this._forklift.idle&&this._level.move("s")}],[37,()=>{this._forklift.idle&&this._level.move("w")}],[49,()=>{this._forklift.idle&&this._level.move("1")}],[50,()=>{this._forklift.idle&&this._level.move("2")}],[51,()=>{this._forklift.idle&&this._level.move("3")}],[27,()=>{// escape
this.onAbort.notify()}],[82,()=>{// r
this.onRestart.notify()}],[80,()=>{window.DEBUG&&0<this._level.solution.moves.length&&this.onPlayback.notify()}]]))}_trackKeyboardOnPlayback(){this._keyboard.track(new Map([[27,()=>{// escape
this.onAbort.notify()}],[82,()=>{// r
this.onRestart.notify()}]]))}_trackKeyboardOnLevelSolved(){this._keyboard.track(new Map([[32,()=>{// space
this.onNext.notify()}]]))}_untrackKeyboard(){this._keyboard.untrack()}_startPlayback(){this._playbackMoves=this._level.solution.moves.split(" "),this._advancePlayback()}_stopPlayback(){this._playbackMoves=[]}_advancePlayback(){this._level.move(this._playbackMoves.shift())}_isPlaybackInProgress(){return 0<this._playbackMoves.length}_settings_onOptionChanged(e,t){"sound_effects_volume"===e&&(this._levelSolvedSound.setVolume(t/100),this._gameSolvedSound.setVolume(t/100))}_ui_onAbort(){this.onAbort.notify()}_ui_onRestart(){this.onRestart.notify()}_uiLevelSolved_onNext(){this.onNext.notify()}_forklift_onIdle(){this._level.isSolved()?(window.DEBUG&&console.log(this._level.moves.join(" ")),this.onLevelSolved.notify()):this._isPlaybackInProgress()?this._advancePlayback():this._keyboard.performActions()}}const D={meshes:["environment"],images:["warehouse_base.png"],fonts:["Native Alien Extended"],sounds:["music.mp3","ambient_sound.mp3","click.mp3"],texts:["maps.json"]};class W extends I{constructor(e){super(e),this._assets=new h(this._scene),this._ui=new O(this),this._uiOptions=new P(this),this._uiHelp=new L(this),this._maps=new l(this),this._levelScreen=new F(this._engine),this._levelPack=y.getLevelPack(),this._nextLevelNo=y.getBookmark(this._levelPack),this._initCallbacks(),this._initEvents()}initAsync(){const e=new Promise(async e=>{await this._assets.loadAsync(D),this._initMaps(),this._createScene(),this._createUI(),this._playMusic(),this._playAmbientSound(),e()});return Promise.all([e,this._levelScreen.initAsync()])}dispose(){this._levelScreen.dispose(),this._stopAmbientSound(),this._stopMusic(),this._disposeUI(),this._disposeEvents(),super.dispose()}_initCallbacks(){this._engine_onRenderLoopCallback=this._engine_onRenderLoop.bind(this),this._settings_onOptionChangedCallback=this._settings_onOptionChanged.bind(this),this._ui_onPlayCallback=this._ui_onPlay.bind(this),this._ui_onOptionsCallback=this._ui_onOptions.bind(this),this._ui_onHelpCallback=this._ui_onHelp.bind(this),this._ui_onNextLevelChangedCallback=this._ui_onNextLevelChanged.bind(this),this._uiOptions_onBackCallback=this._uiOptions_onBack.bind(this),this._uiHelp_onBackCallback=this._uiHelp_onBack.bind(this),this._levelScreen_onAbortCallback=this._levelScreen_onAbort.bind(this),this._levelScreen_onRestartCallback=this._levelScreen_onRestart.bind(this),this._levelScreen_onPlaybackCallback=this._levelScreen_onPlayback.bind(this),this._levelScreen_onLevelSolvedCallback=this._levelScreen_onLevelSolved.bind(this),this._levelScreen_onNextCallback=this._levelScreen_onNext.bind(this)}_initEvents(){y.onOptionChanged.add(this._settings_onOptionChangedCallback),this._ui.onPlay.add(this._ui_onPlayCallback),this._ui.onOptions.add(this._ui_onOptionsCallback),this._ui.onHelp.add(this._ui_onHelpCallback),this._ui.onNextLevelChanged.add(this._ui_onNextLevelChangedCallback),this._uiOptions.onBack.add(this._uiOptions_onBackCallback),this._uiHelp.onBack.add(this._uiHelp_onBackCallback),this._levelScreen.onAbort.add(this._levelScreen_onAbortCallback),this._levelScreen.onRestart.add(this._levelScreen_onRestartCallback),this._levelScreen.onPlayback.add(this._levelScreen_onPlaybackCallback),this._levelScreen.onLevelSolved.add(this._levelScreen_onLevelSolvedCallback),this._levelScreen.onNext.add(this._levelScreen_onNextCallback)}_disposeUI(){this._uiHelp.dispose(),this._uiOptions.dispose(),this._ui.dispose()}_disposeEvents(){y.onOptionChanged.remove(this._settings_onOptionChangedCallback),this._ui.onPlay.remove(this._ui_onPlayCallback),this._ui.onOptions.remove(this._ui_onOptionsCallback),this._ui.onHelp.remove(this._ui_onHelpCallback),this._ui.onNextLevelChanged.remove(this._ui_onNextLevelChangedCallback),this._uiOptions.onBack.remove(this._uiOptions_onBackCallback),this._uiHelp.onBack.remove(this._uiHelp_onBackCallback),this._levelScreen.onAbort.remove(this._levelScreen_onAbortCallback),this._levelScreen.onRestart.remove(this._levelScreen_onRestartCallback),this._levelScreen.onPlayback.remove(this._levelScreen_onPlaybackCallback),this._levelScreen.onLevelSolved.remove(this._levelScreen_onLevelSolvedCallback),this._levelScreen.onNext.remove(this._levelScreen_onNextCallback)}get scene(){return this._scene}get assets(){return this._assets}run(e=200){this._ui.isVisible=!0,this._ui.isEnabled=!1,this._engine.runRenderLoop(this._engine_onRenderLoopCallback),this._fadeIn(e,()=>{this._ui.isEnabled=!0})}stop(){this._ui.isEnabled=!1,this._engine.stopRenderLoop(this._engine_onRenderLoopCallback)}_initMaps(){this._maps.init()}_createScene(){this._scene.ambientColor.set(.9,.9,.9),this._createSpace(),this._createWarehouse(),this._createLights(),this._createCamera(),this._createSounds()}_createSpace(){this._spaceAspect=new S(this),this._spaceAspect.position.set(0,0,0)}_createWarehouse(){this._warehouseAspect=new f(this),this._warehouseAspect.position.set(0,2.8,0)}_createLights(){// light1
const e=new BABYLON.Vector3(0,14,0);this._light1=new BABYLON.PointLight("light1",e,this._scene),this._light1.intensity=750,this._light1.shadowMinZ=9,this._light1.shadowMaxZ=14}_createCamera(){const e=new BABYLON.Vector3(0,3,0);this._camera1=new BABYLON.ArcRotateCamera("camera1",-(i/2),i/9,10,e,this._scene)}_createSounds(){{this._music=this._assets.getSound("music"),this._music.loop=!0;const e=y.getOption("music_volume")/100;this._music.setVolume(e)}{this._ambientSound=this._assets.getSound("ambient_sound"),this._ambientSound.loop=!0;const e=y.getOption("ambient_sound_volume")/100;this._ambientSound.setVolume(e)}}_playMusic(){const e=y.getOption("music_volume")/100;0<e&&this._music.play()}_stopMusic(){this._music.stop()}_playAmbientSound(){const e=y.getOption("ambient_sound_volume")/100;0<e&&this._ambientSound.play()}_stopAmbientSound(){this._ambientSound.stop()}_createUI(){this._ui.create(),this._ui.maxLevelNo=this._maps.getCount(this._levelPack),this._ui.nextLevelNo=y.getBookmark(this._levelPack),this._createUIOptions(),this._createUIHelp()}_createUIOptions(){this._uiOptions.create(),this._uiOptions.isVisible=!1,this._uiOptions.isEnabled=!1,this._uiOptions.alpha=0}_createUIHelp(){this._uiHelp.create(),this._uiHelp.isVisible=!1,this._uiHelp.isEnabled=!1,this._uiHelp.alpha=0}_engine_onRenderLoop(){this._scene.render()}_computeNextLevel(){const e=this._maps.getCount(this._levelPack);return this._nextLevelNo!==e&&(++this._nextLevelNo,y.setBookmark(this._levelPack,n(y.getBookmark(this._levelPack),this._nextLevelNo)),this._ui.nextLevelNo=this._nextLevelNo,!0)}_settings_onOptionChanged(e,t){"music_volume"===e?0<t?(this._music.setVolume(t/100),!this._music.isPlaying&&this._music.play()):this._music.stop():"ambient_sound_volume"==e&&(0<t?(this._ambientSound.setVolume(t/100),!this._ambientSound.isPlaying&&this._ambientSound.play()):this._ambientSound.stop())}_ui_onPlay(){this._ui.isEnabled=!1,this._fadeOut(200,()=>{this._ui.isVisible=!1,this.stop();const e=this._maps.get(this._levelPack,this._nextLevelNo);this._levelScreen.runFirst(new v(e))})}_ui_onOptions(){this._ui.isEnabled=!1,this._ui.fadeOut(200,()=>{this._ui.isVisible=!1,this._uiOptions.isVisible=!0,this._uiOptions.fadeIn(200,()=>{this._uiOptions.isEnabled=!0})})}_ui_onHelp(){this._ui.isEnabled=!1,this._ui.fadeOut(200,()=>{this._ui.isVisible=!1,this._uiHelp.isVisible=!0,this._uiHelp.fadeIn(200,()=>{this._uiHelp.isEnabled=!0})})}_ui_onNextLevelChanged(){this._nextLevelNo=this._ui.nextLevelNo,window.DEBUG||(this._nextLevelNo=a(this._nextLevelNo,y.getBookmark(this._levelPack))),this._ui.nextLevelNo=this._nextLevelNo}_uiOptions_onBack(){this._uiOptions.isEnabled=!1,this._uiOptions.fadeOut(200,()=>{this._uiOptions.isVisible=!1,this._ui.isVisible=!0,this._ui.fadeIn(200,()=>{this._ui.isEnabled=!0})})}_uiHelp_onBack(){this._uiHelp.isEnabled=!1,this._uiHelp.fadeOut(200,()=>{this._uiHelp.isVisible=!1,this._ui.isVisible=!0,this._ui.fadeIn(200,()=>{this._ui.isEnabled=!0})})}_levelScreen_onAbort(){this._levelScreen.abort(()=>{this.run()})}_levelScreen_onRestart(){this._levelScreen.restart()}_levelScreen_onPlayback(){this._levelScreen.playback()}_levelScreen_onLevelSolved(){this._levelScreen.handleLevelSolved()}_levelScreen_onNext(){if(this._computeNextLevel()){const e=this._maps.get(this._levelPack,this._nextLevelNo);this._levelScreen.runNext(new v(e))}else this._levelScreen.handleGameSolved(()=>{this.run(1e3)})}}class H{constructor(){this._canvas=document.getElementById("render_canvas"),this._engine=new BABYLON.Engine(this._canvas,!0),this._mainScreen=new W(this._engine),this._initCallbacks(),this._initEvents()}initAsync(){return this._engine.loadingUIText="Loading...",this._mainScreen.initAsync()}run(){this._mainScreen.run()}stop(){this._mainScreen.stop()}dispose(){this._disposeEvents(),this._mainScreen.dispose(),this._mainScreen=null,this._engine.dispose(),this._engine=null}_initCallbacks(){this._window_onResizeCallback=()=>{this._engine.resize()}}_initEvents(){window.addEventListener("resize",this._window_onResizeCallback)}_disposeEvents(){window.removeEventListener("resize",this._window_onResizeCallback)}}window.DEBUG=!1;let Q=null;window.addEventListener("load",()=>{e(),y.load(),Q=new H,Q.initAsync().then(()=>{Q.run()})}),window.addEventListener("unload",()=>{Q.stop(),Q.dispose(),Q=null,y.save()})})();
